<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ tournament.title }} - 결과 제출</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-gray-100">

    <header class="flex justify-between items-center p-4 bg-white shadow-sm">
        <div class="w-1/3">
            <button class="text-2xl p-4 -ml-4" onclick="history.back()">&larr;</button>
        </div>
        <div class="w-1/3 text-center">
            <a href="{{ url_for('index') }}" class="text-xl font-bold">결과 제출</a>
        </div>
        <div class="w-1/3 flex justify-end items-center gap-4">
           {% if current_user.is_authenticated %}
               <a href="{{ url_for('mypage') }}" class="text-sm font-semibold hover:underline">{{ current_user.username }}</a>
               <a href="{{ url_for('logout') }}" class="bg-gray-200 hover:bg-gray-300 text-sm text-gray-800 py-1 px-3 rounded-md">로그아웃</a>
           {% endif %}
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 lg:p-8" style="margin-top: 0;">
        <div class="bg-white p-6 rounded-lg shadow-sm max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-2">{{ tournament.title }}</h2>
            <p class="text-gray-500 mb-6 border-b pb-4">진행된 경기의 결과를 입력하고 제출해주세요.</p>
            
            <form action="{{ url_for('submit_tournament_results', tournament_id=tournament.id) }}" method="POST">
                <div class="space-y-8">
                    {% set total_rounds = tournament.bracket_data.rounds | length %}
                    {% for round_matches in tournament.bracket_data.rounds %}
                    <div>
                        <h3 class="text-xl font-semibold mb-4">
                            {% if loop.index == total_rounds %} 결승
                            {% elif loop.index == total_rounds - 1 and total_rounds > 1 %} 준결승
                            {% else %} {{ loop.index }}라운드
                            {% endif %}
                        </h3>
                        <div class="space-y-6">
                        {% for match in round_matches %}
                            {# ▼▼▼ '승자'가 정해지지 않은 모든 경기를 일단 보여줍니다. ▼▼▼ #}
                            {% if not match.winner %}
                            <div class="p-4 rounded-md border {% if '승자' not in match.p1 and '승자' not in match.p2 and match.p2 != '부전승' %}bg-white{% else %}bg-gray-100{% endif %}">
                                <p class="font-semibold mb-2 text-gray-800">{{ match.p1 }} vs {{ match.p2 }}</p>
                                
                                {# ▼▼▼ '부전승'이 아니고, 플레이어가 모두 확정된 경우에만 입력창을 활성화합니다. ▼▼▼ #}
                                {% if '승자' not in match.p1 and '승자' not in match.p2 and match.p2 != '부전승' %}
                                    <div class="grid grid-cols-2 gap-4">
                                        <select name="{{ match.id }}_winner" required class="form-select">
                                            <option value="" disabled selected>승자 선택</option>
                                            <option value="{{ match.p1 }}">{{ match.p1 }}</option>
                                            <option value="{{ match.p2 }}">{{ match.p2 }}</option>
                                        </select>
                                        <select name="{{ match.id }}_score" required class="form-select">
                                            <option value="2:0">2:0</option>
                                            <option value="2:1">2:1</option>
                                        </select>
                                    </div>
                                {% else %}
                                    {# ▼▼▼ 아직 플레이어를 확정할 수 없는 경기는 비활성화된 상태로 안내 문구를 보여줍니다. ▼▼▼ #}
                                    <div class="text-sm text-gray-500 text-center py-2">
                                        상위 라운드 결과가 확정되면 입력할 수 있습니다.
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <button type="submit" class="w-full bg-main button mt-8">결과 일괄 제출</button>
            </form>
        </div>
    </main>

</body>
</html>